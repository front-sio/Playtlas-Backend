// Revenue Analytics Service Schema
// This service aggregates revenue data from all other services

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Platform Revenue Metrics (time-series data)
model PlatformRevenue {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date
  period          String    // 'daily', 'weekly', 'monthly', 'yearly'
  tournamentFees  Float     @default(0)
  depositFees     Float     @default(0)
  withdrawalFees  Float     @default(0)
  transferFees    Float     @default(0)
  totalRevenue    Float     @default(0)
  currency        String    @default("TZS")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date, period])
  @@index([date])
  @@index([period])
}

// Revenue by Payment Provider
model RevenueByProvider {
  id              String    @id @default(cuid())
  provider        String    // 'mpesa', 'tigo_pesa', 'airtel_money', 'halotel'
  date            DateTime  @db.Date
  depositRevenue  Float     @default(0)
  withdrawalRevenue Float   @default(0)
  transactionFees Float     @default(0)
  totalRevenue    Float     @default(0)
  currency        String    @default("TZS")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([provider, date])
  @@index([provider])
  @@index([date])
}

// Revenue by Tournament
model RevenueByTournament {
  id              String    @id @default(cuid())
  tournamentId    String
  tournamentName  String?
  date            DateTime  @db.Date
  entryFees       Float     @default(0)
  platformFees    Float     @default(0)
  totalRevenue    Float     @default(0)
  playersCount    Int       @default(0)
  currency        String    @default("TZS")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([tournamentId, date])
  @@index([tournamentId])
  @@index([date])
}

// Agent Revenue Metrics
model AgentRevenue {
  id                  String    @id @default(cuid())
  agentId             String
  userId              String
  agentName           String?
  date                DateTime  @db.Date
  period              String    // 'daily', 'weekly', 'monthly', 'yearly'
  commissionEarned    Float     @default(0)
  playersRegistered   Int       @default(0)
  activePlayers       Int       @default(0)
  totalDeposits       Float     @default(0)
  totalWithdrawals    Float     @default(0)
  playerRevenue       Float     @default(0) // Revenue generated by agent's players
  currency            String    @default("TZS")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([agentId, date, period])
  @@index([agentId])
  @@index([date])
}

// Player Revenue Metrics
model PlayerRevenue {
  id                  String    @id @default(cuid())
  playerId            String
  username            String?
  agentId             String?   // Agent who registered this player
  agentName           String?
  date                DateTime  @db.Date
  period              String    // 'daily', 'weekly', 'monthly', 'yearly'
  totalWinnings       Float     @default(0)
  totalLosses         Float     @default(0)
  feesPaid            Float     @default(0)
  netProfit           Float     @default(0)
  totalDeposits       Float     @default(0)
  totalWithdrawals    Float     @default(0)
  gamesPlayed         Int       @default(0)
  tournamentsPlayed   Int       @default(0)
  lifetimeValue       Float     @default(0)
  profitabilityScore  Float     @default(0) // -100 to 100
  currency            String    @default("TZS")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([playerId, date, period])
  @@index([playerId])
  @@index([agentId])
  @@index([date])
}

// Revenue Alerts
model RevenueAlert {
  id              String    @id @default(cuid())
  alertType       String    // 'revenue_threshold', 'anomaly', 'low_revenue', 'high_revenue'
  severity        String    // 'low', 'medium', 'high', 'critical'
  title           String
  description     String
  metricName      String    // 'total_revenue', 'agent_revenue', 'player_revenue'
  thresholdValue   Float?
  currentValue    Float?
  percentageChange Float?
  isResolved      Boolean   @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([alertType])
  @@index([isResolved])
  @@index([createdAt])
}

// Scheduled Reports
model ScheduledReport {
  id              String    @id @default(cuid())
  reportName      String
  reportType      String    // 'platform_revenue', 'agent_revenue', 'player_revenue', 'custom'
  schedule        String    // 'daily', 'weekly', 'monthly'
  recipients      String[]  // Email addresses
  parameters      Json?     // Report parameters (date range, filters, etc.)
  isActive        Boolean   @default(true)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  createdBy       String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([reportType])
  @@index([isActive])
}

// Revenue Aggregation Jobs
model AggregationJob {
  id              String    @id @default(cuid())
  jobType         String    // 'platform_revenue', 'agent_revenue', 'player_revenue'
  status          String    // 'pending', 'running', 'completed', 'failed'
  startDate       DateTime  @db.Date
  endDate         DateTime  @db.Date?
  recordsProcessed Int       @default(0)
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([jobType])
  @@index([status])
  @@index([startDate])
}
