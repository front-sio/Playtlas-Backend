# Revenue Analytics Service

Enterprise-level revenue analytics service for the PlayAtlas platform, providing comprehensive financial insights similar to TikTok Ads, Facebook, and Google analytics dashboards.

## Features

### Platform Revenue Tracking
- Daily, weekly, monthly, and yearly revenue aggregation
- Breakdown by revenue source (tournament fees, deposit fees, withdrawal fees, transfer fees)
- Revenue trends and growth analysis
- Daily average calculations
- Payment provider breakdown

### Agent Revenue Analytics
- Agent performance tracking
- Commission earned calculation
- Player registration metrics
- Revenue generated by agent's players
- Top agent rankings

### Player Revenue Analysis
- Lifetime value (LTV) calculation
- Profitability score (-100 to 100)
- Winnings and losses tracking
- Fees paid analysis
- Deposit and withdrawal history
- Games and tournaments played
- Top value players identification

### Dashboard Features
- Real-time revenue stats
- Today, yesterday, weekly, and monthly comparisons
- Growth rate calculations
- Top performers (agents and players)
- CSV export functionality
- Advanced filtering and search
- Pagination for large datasets

## Architecture

```
┌─────────────────┐
│   Frontend      │
│  (Next.js)      │
└────────┬────────┘
         │ HTTP/REST
         ▼
┌─────────────────────────────────┐
│  Revenue Analytics Service      │
│  (Node.js + Express)         │
├─────────────────────────────────┤
│  Controllers                 │
│  - Revenue Aggregation       │
│  - Dashboard Stats           │
│  - Agent Revenue            │
│  - Player Revenue           │
├─────────────────────────────────┤
│  Services                   │
│  - Revenue Aggregation      │
│  - Data Fetching           │
│  - Calculation Logic       │
├─────────────────────────────────┤
│  Database                   │
│  (PostgreSQL + Prisma)      │
└────────┬────────────────────┘
         │
         ├──────────────┬──────────────┬──────────────┐
         ▼              ▼              ▼              ▼
    ┌─────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
    │ Wallet  │   │ Payment  │   │  Agent   │   │Tournament│
    │ Service │   │ Service  │   │ Service  │   │ Service  │
    └─────────┘   └──────────┘   └──────────┘   └──────────┘
```

## Database Schema

### PlatformRevenue
- Daily, weekly, monthly, yearly revenue data
- Breakdown by revenue type
- Trend analysis support

### RevenueByProvider
- Revenue segmented by payment provider (M-Pesa, Tigo Pesa, Airtel, Halotel)
- Deposit and withdrawal revenue
- Transaction fees

### AgentRevenue
- Agent performance metrics
- Commission tracking
- Player registration counts
- Revenue generated by agent's players

### PlayerRevenue
- Player lifetime value (LTV)
- Profitability score
- Winnings, losses, fees
- Games and tournaments played
- Deposit/withdrawal history

### RevenueAlerts
- Threshold-based alerts
- Anomaly detection
- Alert resolution tracking

### ScheduledReports
- Automated report generation
- Daily, weekly, monthly schedules
- Email recipients configuration

## API Endpoints

### Aggregation
```bash
POST /api/revenue/aggregate
Body: { date: "2024-01-01", type: "all" }
```

### Platform Revenue
```bash
GET /api/revenue/platform?startDate=2024-01-01&endDate=2024-01-31
```

### Agent Revenue
```bash
GET /api/revenue/agent?startDate=2024-01-01&endDate=2024-01-31&agentId={optional}
```

### Player Revenue
```bash
GET /api/revenue/player?startDate=2024-01-01&endDate=2024-01-31&playerId={optional}&limit=20&offset=0
```

### Dashboard Stats
```bash
GET /api/revenue/dashboard
```

### Revenue by Provider
```bash
GET /api/revenue/provider?startDate=2024-01-01&endDate=2024-01-31&provider={optional}
```

### Alerts
```bash
GET /api/revenue/alerts?isResolved=false&alertType=anomaly
POST /api/revenue/alerts
PUT /api/revenue/alerts/:alertId/resolve
```

## Metrics & Calculations

### Platform Metrics
- **Total Revenue**: Sum of all revenue streams
- **Daily Average**: Total revenue / number of days
- **Trend**: (Current period - Previous period) / Previous period * 100
- **Growth Rate**: Day-over-day or month-over-month comparison

### Agent Metrics
- **Total Revenue**: Sum of player revenue for agent's players
- **Commission**: Revenue * commission rate (typically 10%)
- **Players Registered**: Total players registered by agent
- **Active Players**: Players with activity in the period

### Player Metrics
- **Lifetime Value (LTV)**: Current wallet balance + historical deposits
- **Net Profit**: Total winnings - Total losses
- **Profitability Score**: (Net Profit / Total Activity) * 100
  - > 50: High profitability
  - 0-50: Positive
  - -50-0: Negative
  - < -50: High loss

## Frontend Pages

### Revenue Dashboard (`/admin/revenue`)
- Real-time overview stats
- Today, yesterday, weekly, monthly revenue
- Revenue source breakdown
- Top agents and players
- Navigation to detailed pages

### Platform Revenue (`/admin/revenue/platform`)
- Detailed platform analytics
- Date range filtering (today, week, month, custom)
- Revenue breakdown table
- Trend indicators
- CSV export

### Agent Revenue (`/admin/revenue/agents`)
- Agent performance table
- Commission tracking
- Player counts
- Search and filter
- CSV export

### Player Revenue (`/admin/revenue/players`)
- Player profitability analysis
- Lifetime value ranking
- Winnings/losses breakdown
- Games and tournaments played
- Profitability score
- Pagination
- CSV export

## Installation

### Prerequisites
- Node.js 18+
- PostgreSQL 14+
- npm or yarn

### Setup

1. Install dependencies:
```bash
npm install
```

2. Set up environment variables:
```bash
cp .env.example .env
# Edit .env with your configuration
```

3. Initialize database:
```bash
npx prisma generate
npx prisma db push
```

4. Start the service:
```bash
npm run dev    # Development
npm start       # Production
```

## Docker Deployment

### Build and run with Docker:
```bash
docker build -t revenue-analytics-service .
docker run -p 3008:3008 --env-file .env revenue-analytics-service
```

### With Docker Compose:
```yaml
services:
  revenue-analytics:
    build: ./services/revenue-analytics-service
    ports:
      - "3008:3008"
    environment:
      - DATABASE_URL=${REVENUE_ANALYTICS_DB_URL}
      - PORT=3008
    depends_on:
      - postgres
```

## Environment Variables

| Variable | Description | Default |
|-----------|-------------|----------|
| `DATABASE_URL` | PostgreSQL connection string | - |
| `PORT` | Server port | 3008 |
| `NODE_ENV` | Environment (development/production) | development |
| `FRONTEND_URL` | Frontend URL for CORS | http://localhost:3000 |
| `WALLET_SERVICE_URL` | Wallet service URL | http://localhost:3007 |
| `PAYMENT_SERVICE_URL` | Payment service URL | http://localhost:3003 |
| `AGENT_SERVICE_URL` | Agent service URL | http://localhost:3010 |
| `TOURNAMENT_SERVICE_URL` | Tournament service URL | http://localhost:3004 |
| `LOG_LEVEL` | Logging level | info |
| `RATE_LIMIT_WINDOW_MS` | Rate limit window | 900000 |
| `RATE_LIMIT_MAX_REQUESTS` | Max requests per window | 100 |

## Security

- Helmet for security headers
- CORS configuration
- Rate limiting (100 requests per 15 minutes)
- Role-based access control (admin only)
- Input validation
- SQL injection prevention (Prisma)

## Monitoring & Logging

- Winston logging with rotation
- Separate error and combined logs
- Structured JSON logging in production
- Console logging in development

## Performance Optimizations

- Database indexing on frequently queried fields
- Batch processing for player revenue aggregation
- Pagination for large datasets
- Caching of dashboard stats (1-minute intervals)
- Efficient Prisma queries with selective fields

## Enterprise Features

### Real-time Updates
- Dashboard auto-refreshes every minute
- Live revenue tracking
- Instant metric updates

### Export Functionality
- CSV export for all data tables
- Date range exports
- Filtered data exports

### Alert System
- Threshold-based alerts
- Anomaly detection
- Alert resolution tracking
- Metadata support for context

### Scheduled Reports
- Daily, weekly, monthly reports
- Automated email delivery
- Custom report parameters

## Scalability

- Microservices architecture
- Horizontal scaling ready
- Database connection pooling
- Efficient data aggregation
- Batch processing support

## Future Enhancements

- Real-time WebSocket updates
- Machine learning for revenue prediction
- Advanced anomaly detection
- Custom report builder
- Data visualization with charts
- Multi-currency support
- Historical data retention policies

## Support

For issues or questions, please refer to the main project documentation.
