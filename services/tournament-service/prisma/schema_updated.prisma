generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("TOURNAMENT_DATABASE_URL")
}

model Tournament {
  tournamentId         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clubId               String    @db.Uuid
  name                 String
  description          String?
  entryFee             Decimal   @db.Decimal(15, 2)
  maxPlayers           Int       @default(32)
  currentPlayers       Int       @default(0)
  status               String    @default("upcoming")
  stage                String    @default("registration")
  competitionWalletId  String?   @db.Uuid
  startTime            DateTime?
  endTime              DateTime?
  matchDuration        Int       @default(1200) @map("season_duration")
  winnerId             String?   @db.Uuid
  metadata             Json?
  
  // Club operating hours and match settings
  operatingHoursStart  String    @default("11:00:00") @map("operating_hours_start")
  operatingHoursEnd    String    @default("23:00:00") @map("operating_hours_end")
  matchDurationMinutes Int       @default(5) @map("match_duration_minutes")
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  seasons              Season[]
  tournamentPlayers    TournamentPlayer[]
  matches              Match[]
  club                 Club     @relation(fields: [clubId], references: [clubId], onDelete: Restrict)

  @@map("tournaments")
}

model Season {
  seasonId            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tournamentId        String    @db.Uuid
  clubId              String    @db.Uuid
  seasonNumber        Int
  name                String?
  status              String    @default("active")
  joiningClosed       Boolean   @default(false)
  matchesGenerated    Boolean   @default(false)
  startTime           DateTime
  endTime             DateTime
  createdAt           DateTime  @default(now())

  tournament          Tournament @relation(fields: [tournamentId], references: [tournamentId], onDelete: Cascade)
  club                Club      @relation(fields: [clubId], references: [clubId], onDelete: Restrict)
  tournamentPlayers   TournamentPlayer[]
  matches             Match[]
  groupStandings      GroupStanding[]
  bracketMatches      BracketMatch[]

  @@map("seasons")
}

model Match {
  matchId               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("match_id")
  tournamentId          String    @db.Uuid @map("tournament_id")
  seasonId              String    @db.Uuid @map("season_id")
  clubId                String    @db.Uuid @map("club_id")
  
  // Match identification
  round                 String    // GROUP, R16, QF, SF, FINAL
  groupLabel            String?   @map("group_label") @db.VarChar(1)
  matchNumber           Int       @map("match_number")
  
  // Players
  player1Id             String?   @db.Uuid @map("player1_id")
  player2Id             String?   @db.Uuid @map("player2_id")
  winnerId              String?   @db.Uuid @map("winner_id")
  
  // Scores
  player1Score          Int       @default(0) @map("player1_score")
  player2Score          Int       @default(0) @map("player2_score")
  
  // Scheduling
  scheduledStartAt      DateTime? @map("scheduled_start_at")
  assignedDeviceId      String?   @db.Uuid @map("assigned_device_id")
  assignedAgentId       String?   @db.Uuid @map("assigned_agent_id")
  
  // Status
  status                String    @default("SCHEDULED")
  
  // Tournament progression  
  winnerAdvancesToMatchId String? @db.Uuid @map("winner_advances_to_match_id")
  winnerAdvancesToSlot    String? @map("winner_advances_to_slot") @db.VarChar(10)
  
  // Match data
  startedAt             DateTime? @map("started_at")
  completedAt           DateTime? @map("completed_at")
  matchDurationSeconds  Int?      @map("match_duration_seconds")
  endReason             String?   @map("end_reason") @db.VarChar(50)
  gameData              Json?     @map("game_data")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  tournament            Tournament @relation(fields: [tournamentId], references: [tournamentId], onDelete: Cascade)
  season                Season     @relation(fields: [seasonId], references: [seasonId], onDelete: Cascade)
  
  // Self-referencing relationship for tournament progression
  advancesToMatch       Match?     @relation("MatchProgression", fields: [winnerAdvancesToMatchId], references: [matchId])
  previousMatches       Match[]    @relation("MatchProgression")
  
  // Bracket relationship
  bracketMatch          BracketMatch?

  @@map("matches")
}

model GroupStanding {
  standingId         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("standing_id")
  seasonId           String   @db.Uuid @map("season_id")
  groupLabel         String   @map("group_label") @db.VarChar(1)
  playerId           String   @db.Uuid @map("player_id")
  
  // Stats
  matchesPlayed      Int      @default(0) @map("matches_played")
  wins               Int      @default(0)
  losses             Int      @default(0)
  pointsFor          Int      @default(0) @map("points_for")
  pointsAgainst      Int      @default(0) @map("points_against")
  
  // Calculated fields
  winPercentage      Decimal  @default(0) @map("win_percentage") @db.Decimal(5,4)
  pointDifference    Int      @default(0) @map("point_difference")
  
  // Ranking
  groupPosition      Int?     @map("group_position")
  qualified          Boolean  @default(false)
  
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  season             Season   @relation(fields: [seasonId], references: [seasonId], onDelete: Cascade)

  @@unique([seasonId, groupLabel, playerId])
  @@map("group_standings")
}

model DeviceSchedule {
  scheduleId  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("schedule_id")
  deviceId    String    @db.Uuid @map("device_id")
  clubId      String    @db.Uuid @map("club_id")
  
  // Time slot
  startTime   DateTime  @map("start_time")
  endTime     DateTime  @map("end_time")
  
  // Assignment
  matchId     String?   @db.Uuid @map("match_id")
  status      String    @default("AVAILABLE")
  
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([deviceId, startTime])
  @@map("device_schedules")
}

model BracketMatch {
  bracketId       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("bracket_id")
  seasonId        String   @db.Uuid @map("season_id")
  round           String
  position        Int      // Position in bracket
  
  // Match reference
  matchId         String?  @unique @db.Uuid @map("match_id")
  
  // Bracket metadata
  bracketLevel    Int      @map("bracket_level") // 1=Final, 2=SF, 3=QF, 4=R16
  parentMatchId   String?  @db.Uuid @map("parent_match_id")
  
  createdAt       DateTime @default(now()) @map("created_at")

  season          Season   @relation(fields: [seasonId], references: [seasonId], onDelete: Cascade)
  match           Match?   @relation(fields: [matchId], references: [matchId])

  @@unique([seasonId, round, position])
  @@map("bracket_matches")
}

model TournamentPlayer {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tournamentId        String    @db.Uuid
  seasonId            String?   @db.Uuid
  playerId            String    @db.Uuid
  status              String    @default("registered")
  registeredAt        DateTime  @default(now())
  eliminatedAt        DateTime?

  tournament          Tournament @relation(fields: [tournamentId], references: [tournamentId], onDelete: Cascade)
  season              Season?    @relation(fields: [seasonId], references: [seasonId], onDelete: Cascade)

  @@map("tournament_players")
}

model TournamentCommandLog {
  commandId           String   @id @db.Uuid
  action              String
  status              String
  tournamentId        String?  @db.Uuid
  error               String?
  createdAt           DateTime @default(now())

  @@map("tournament_command_logs")
}

model Club {
  clubId              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  locationText        String?
  status              String    @default("active")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tournaments         Tournament[]
  seasons             Season[]

  @@map("clubs")
}