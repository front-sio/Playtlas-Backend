services:
  # ==========================================================
  # Redis
  # ==========================================================
  redis:
    image: redis:6.2-alpine
    container_name: pool-game-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      - dokploy-network

  # ==========================================================
  # Kafka (Official Apache image, KRaft mode - NO Zookeeper)
  # Internal broker: pool-game-kafka:9092
  # ==========================================================
  kafka:
    image: apache/kafka:3.7.2
    container_name: pool-game-kafka
    environment:
      # KRaft single-node
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@pool-game-kafka:9093"
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listeners
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://pool-game-kafka:9092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Optional, convenient for dev
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: "3"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
    networks:
      - dokploy-network

  # ==========================================================
  # Kafka topic bootstrapper (one-time)
  # ==========================================================
  kafka-init:
    image: apache/kafka:3.7.2
    container_name: pool-game-kafka-init
    depends_on:
      - kafka
    entrypoint: ["sh", "-c"]
    command: >
      "until /opt/kafka/bin/kafka-topics.sh --bootstrap-server pool-game-kafka:9092 --list >/dev/null 2>&1; do
        echo 'waiting for kafka...';
        sleep 2;
      done;
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server pool-game-kafka:9092 --create --if-not-exists --topic tournament.generate_matches --partitions 3 --replication-factor 1;
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server pool-game-kafka:9092 --create --if-not-exists --topic tournament.season_completed --partitions 3 --replication-factor 1;
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server pool-game-kafka:9092 --create --if-not-exists --topic tournament.season_cancelled --partitions 3 --replication-factor 1;
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server pool-game-kafka:9092 --create --if-not-exists --topic tournament.match_result --partitions 3 --replication-factor 1;"
    restart: "no"
    networks:
      - dokploy-network

  # ==========================================================
  # Kafka UI (optional)
  # ==========================================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: pool-game-kafka-ui
    environment:
      - KAFKA_CLUSTERS_0_NAME=pool-game
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=pool-game-kafka:9092
    ports:
      - "8089:8080"
    depends_on:
      - kafka
    networks:
      - dokploy-network

  # ==========================================================
  # API Gateway (internal 6000)
  # ==========================================================
  api-gateway:
    build:
      context: .
      dockerfile: ./api-gateway/Dockerfile
    container_name: pool-game-api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8080}:${API_GATEWAY_INTERNAL_PORT:-8080}"
    environment:
      PORT: ${API_GATEWAY_INTERNAL_PORT}
      NODE_ENV: ${NODE_ENV}
      CORS_ORIGIN: ${CORS_ORIGIN}
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_URL: ${REDIS_URL}
      API_GATEWAY_SOCKET_TOKEN: ${API_GATEWAY_SOCKET_TOKEN}

      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      WALLET_SERVICE_URL: ${WALLET_SERVICE_URL}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL}
      TOURNAMENT_SERVICE_URL: ${TOURNAMENT_SERVICE_URL}
      PLAYER_SERVICE_URL: ${PLAYER_SERVICE_URL}
      MATCHMAKING_SERVICE_URL: ${MATCHMAKING_SERVICE_URL}
      GAME_SERVICE_URL: ${GAME_SERVICE_URL}
      ADMIN_SERVICE_URL: ${ADMIN_SERVICE_URL}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL}
      AGENT_SERVICE_URL: ${AGENT_SERVICE_URL}
      REVENUE_ANALYTICS_SERVICE_URL: ${REVENUE_ANALYTICS_SERVICE_URL}

      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      SOCKET_IO_CORS_ORIGIN: ${SOCKET_IO_CORS_ORIGIN}
    depends_on:
      - auth-service
      - player-service
      - game-service
      - matchmaking-service
      - tournament-service
      - payment-service
      - wallet-service
      - admin-service
      - agent-service
      - notification-service
      - revenue-analytics-service
    networks:
      - dokploy-network

  # ==========================================================
  # Auth Service
  # ==========================================================
  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    container_name: pool-game-auth-service
    ports:
      - "${AUTH_SERVICE_PORT:-3011}:3011"
    environment:
      PORT: ${AUTH_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      AUTH_DATABASE_URL: ${AUTH_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN}
      CORS_ORIGIN: ${CORS_ORIGIN}
      WALLET_SERVICE_URL: ${WALLET_SERVICE_URL}
      PLAYER_SERVICE_URL: ${PLAYER_SERVICE_URL}
      REDIS_URL: ${REDIS_BULLMQ_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: auth-service
      KAFKA_GROUP_ID: auth-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Player Service
  player-service:
    build:
      context: .
      dockerfile: ./services/player-service/Dockerfile
    container_name: pool-game-player-service
    ports:
      - "${PLAYER_SERVICE_PORT:-3002}:3002"
    environment:
      PORT: ${PLAYER_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      PLAYER_DATABASE_URL: ${PLAYER_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: player-service
      KAFKA_GROUP_ID: player-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Game Service
  game-service:
    build:
      context: .
      dockerfile: ./services/game-service/Dockerfile
    container_name: pool-game-game-service
    ports:
      - "${GAME_SERVICE_PORT:-3006}:3006"
    environment:
      PORT: ${GAME_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      GAME_DATABASE_URL: ${GAME_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: game-service
      KAFKA_GROUP_ID: game-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Matchmaking Service
  matchmaking-service:
    build:
      context: .
      dockerfile: ./services/matchmaking-service/Dockerfile
    container_name: pool-game-matchmaking-service
    ports:
      - "${MATCHMAKING_SERVICE_PORT:-3009}:3009"
    environment:
      PORT: ${MATCHMAKING_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      MATCHMAKING_DATABASE_URL: ${MATCHMAKING_DATABASE_URL}
      TOURNAMENT_DATABASE_URL: ${TOURNAMENT_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      GAME_SERVICE_URL: ${GAME_SERVICE_URL}
      MATCH_QUEUE_ENABLED: ${MATCH_QUEUE_ENABLED}
      SOCKET_IO_CORS_ORIGIN: ${SOCKET_IO_CORS_ORIGIN}
      MATCHMAKING_TIMEOUT: ${MATCHMAKING_TIMEOUT}
      MAX_QUEUE_SIZE: ${MAX_QUEUE_SIZE}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: matchmaking-service
      KAFKA_GROUP_ID: matchmaking-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Tournament Service
  tournament-service:
    build:
      context: .
      dockerfile: ./services/tournament-service/Dockerfile
    container_name: pool-game-tournament-service
    ports:
      - "${TOURNAMENT_SERVICE_PORT:-3005}:3005"
    environment:
      PORT: ${TOURNAMENT_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      TOURNAMENT_DATABASE_URL: ${TOURNAMENT_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      WALLET_SERVICE_URL: ${WALLET_SERVICE_URL}
      API_GATEWAY_URL: ${API_GATEWAY_URL}
      API_GATEWAY_SOCKET_TOKEN: ${API_GATEWAY_SOCKET_TOKEN}
      REDIS_URL: ${REDIS_BULLMQ_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: tournament-service
      KAFKA_GROUP_ID: tournament-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Payment Service
  payment-service:
    build:
      context: .
      dockerfile: ./services/payment-service/Dockerfile
    container_name: pool-game-payment-service
    ports:
      - "${PAYMENT_SERVICE_PORT:-3003}:3003"
    environment:
      PORT: ${PAYMENT_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      PAYMENT_DATABASE_URL: ${PAYMENT_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      WALLET_SERVICE_URL: ${WALLET_SERVICE_URL}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: payment-service
      KAFKA_GROUP_ID: payment-service-group
      AIRTEL_LIPA_NUMBER: ${AIRTEL_LIPA_NUMBER}
      TIGO_LIPA_NUMBER: ${TIGO_LIPA_NUMBER}
      HALOPESA_LIPA_NUMBER: ${HALOPESA_LIPA_NUMBER}
      MIN_DEPOSIT_AMOUNT: ${MIN_DEPOSIT_AMOUNT}
      MAX_DEPOSIT_AMOUNT: ${MAX_DEPOSIT_AMOUNT}
      MIN_WITHDRAWAL_AMOUNT: ${MIN_WITHDRAWAL_AMOUNT}
      MAX_WITHDRAWAL_AMOUNT: ${MAX_WITHDRAWAL_AMOUNT}
      WITHDRAWAL_FEE_PERCENTAGE: ${WITHDRAWAL_FEE_PERCENTAGE}
      DEPOSIT_FEE_PERCENTAGE: ${DEPOSIT_FEE_PERCENTAGE}
      SYSTEM_WALLET_ID: ${SYSTEM_WALLET_ID}
      PLATFORM_WALLET_ID: ${PLATFORM_WALLET_ID}
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Wallet Service
  wallet-service:
    build:
      context: .
      dockerfile: ./services/wallet-service/Dockerfile
    container_name: pool-game-wallet-service
    ports:
      - "${WALLET_SERVICE_PORT:-3004}:3004"
    environment:
      PORT: ${WALLET_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      WALLET_DATABASE_URL: ${WALLET_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      SYSTEM_WALLET_ID: ${SYSTEM_WALLET_ID}
      PLATFORM_WALLET_ID: ${PLATFORM_WALLET_ID}
      CORS_ORIGIN: ${CORS_ORIGIN}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL}
      REDIS_URL: ${REDIS_BULLMQ_URL}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: wallet-service
      KAFKA_GROUP_ID: wallet-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Admin Service
  admin-service:
    build:
      context: .
      dockerfile: ./services/admin-service/Dockerfile
    container_name: pool-game-admin-service
    ports:
      - "${ADMIN_SERVICE_PORT:-3070}:3070"
    environment:
      PORT: ${ADMIN_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      ADMIN_DATABASE_URL: ${ADMIN_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      WALLET_SERVICE_URL: ${WALLET_SERVICE_URL}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL}
      GAME_SERVICE_URL: ${GAME_SERVICE_URL}
      AGENT_SERVICE_URL: ${AGENT_SERVICE_URL}
      TOURNAMENT_SERVICE_URL: ${TOURNAMENT_SERVICE_URL}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: admin-service
      KAFKA_GROUP_ID: admin-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Agent Service
  agent-service:
    build:
      context: .
      dockerfile: ./services/agent-service/Dockerfile
    container_name: pool-game-agent-service
    ports:
      - "${AGENT_SERVICE_PORT:-3010}:3010"
    environment:
      PORT: ${AGENT_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      AGENT_DATABASE_URL: ${AGENT_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      PLAYER_SERVICE_URL: ${PLAYER_SERVICE_URL}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: agent-service
      KAFKA_GROUP_ID: agent-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Notification Service
  notification-service:
    build:
      context: .
      dockerfile: ./services/notification-service/Dockerfile
    container_name: pool-game-notification-service
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-3008}:3008"
    environment:
      PORT: ${NOTIFICATION_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      NOTIFICATION_DATABASE_URL: ${NOTIFICATION_DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      API_GATEWAY_SOCKET_TOKEN: ${API_GATEWAY_SOCKET_TOKEN}

      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_SECURE: ${SMTP_SECURE}
      FROM_EMAIL: ${FROM_EMAIL}
      APP_NAME: ${APP_NAME}
      SMS_API_KEY: ${SMS_API_KEY}

      REDIS_URL: ${REDIS_BULLMQ_URL}

      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER}
      MAILJET_API_KEY: ${MAILJET_API_KEY}
      MAILJET_API_SECRET: ${MAILJET_API_SECRET}
      MAIL_FROM_EMAIL: ${MAIL_FROM_EMAIL}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME}

      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: notification-service
      KAFKA_GROUP_ID: notification-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

  # Revenue Analytics Service
  revenue-analytics-service:
    build:
      context: .
      dockerfile: ./services/revenue-analytics-service/Dockerfile
    container_name: pool-game-revenue-analytics-service
    ports:
      - "${REVENUE_ANALYTICS_SERVICE_PORT:-3012}:3012"
    environment:
      PORT: ${REVENUE_ANALYTICS_SERVICE_PORT}
      NODE_ENV: ${NODE_ENV}
      DATABASE_URL: ${REVENUE_ANALYTICS_DATABASE_URL}
      FRONTEND_URL: ${FRONTEND_URL}

      WALLET_SERVICE_URL: ${WALLET_SERVICE_URL}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL}
      AGENT_SERVICE_URL: ${AGENT_SERVICE_URL}
      TOURNAMENT_SERVICE_URL: ${TOURNAMENT_SERVICE_URL}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}

      LOG_LEVEL: ${LOG_LEVEL}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS}

      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_CLIENT_ID: revenue-analytics-service
      KAFKA_GROUP_ID: revenue-analytics-service-group
    depends_on:
      - redis
      - kafka
    networks:
      - dokploy-network

volumes:
  postgres_data:

networks:
  dokploy-network:
    external: true
